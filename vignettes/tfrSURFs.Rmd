---
title: |
    | *tfrSURFs*
    | Brief User Guide
date: |
    | `r format(Sys.time(), "%d %b %Y")`
    |
    | (`r paste0("_tfrSURFs_ version ", packageVersion("tfrSURFs"), ")")`
output: 
   rmarkdown::html_vignette:
     includes:
       before_body: vignette2.css
     toc: true
     number_sections: true
   pdf_document: 
     includes:
       in_header: preamble.tex
     toc: true
     number_sections: true
     keep_tex: false
#     extra_dependencies: ["pdflscape", "mathrsfs"]
     pandoc_args: ["--columns=100"]
# bibliography: 'bibliography.bib'
link-citations: true
always_allow_html: true	 
vignette: >
  %\VignetteIndexEntry{tfrSURFs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

***
**DISCLAIMER:** The views expressed herein are those of the authors and do not necessarily reflect the views of the United Nations.

**Access this vignette from *R* with the following command:**
```
vignette("tfrSURFs", package = "tfrSURFs")
```

***


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r knitr-setup, include = FALSE}
knitr::opts_chunk$set(eval = FALSE)
```


# Preparation of Inputs

## TFR Trajectories

A complete set of posterior trajectories for total fertility rate (TFR) is needed. These can be obtained either by generating them yourself using the *bayesTFR* package, or downloading a pre-completed run (file size 1.7G). The *bayesTFR* package is part of the BayesPop project, which is described [here](https://bayespop.csss.washington.edu/data/bayesTFR/TFRsimWPP2024/TFR1unc/README.r "BayesPop project homepage"). 


### Either ... Generate Yourself

1. Download and install *bayesTFR* from [here](https://github.com/PPgp/bayesTFR "Link to the 'bayesTFR' package on GitHub").
2. Run [this](https://bayespop.csss.washington.edu/data/bayesTFR/TFRsimWPP2024/TFR1unc/README.r "R script to generate TFR trajectories using 'bayesTFR' package ") *R* script. It is recommended to save the script as a .R file and `source` it into your *R* session (see `?source` within *R*), or run it via the command line using `R CMD BATCH` (see `R CMD BATCH --help` at the command line). This file is referenced on the [Download page](https://bayespop.csss.washington.edu/download/index.html) page of the BayesPop website.


### Or ... Download

You can download a completed run of *bayesTFR* for the 2024 revision of *World Population Prospects* (United Nations, 2024) from [here](https://bayespop.csss.washington.edu/data/bayesTFR/TFR1simWPP2024.tgz "Link to .tgz archive containing a completed run of 'bayesTFR' "). This file is referenced on the [Download page](https://bayespop.csss.washington.edu/download/index.html) page of the BayesPop website.



# Identification of TFR SURFs

## Estimate SURF Probabilities

Launch *R* and set the variable `bayesTFR_output_dir` to the path to the directory containing the TFR trajectories (see previous section). Issue the following commands:

```{r surf-probabilities}
library(tfrSURFs)

tfr_surf_df_list <- make_tfr_surfs(sim.dir = bayesTFR_output_dir)
```

The output, `tfr_surf_df_list` is a list with one element per country. Each element is a single data frame with one row for each of the years between (by default) 1950 and 2050 (these can be changed using the `year_lim` argument). Among other things, the data frames contain the probabilities of a SURF for each year in the `"surf_prob"` column.

If you only need results for a subset of countries, you can use the `country_codes` argument to specify them. See `?make _tfr_surfs` from within *R* for complete documentation of all arguments.

None-probabilistic SURFs can be generated by adding the argument `median_only = FALSE`:

```{r non-prob-surfs}
tfr_surf_df_list_non_prob <- make_tfr_surfs(sim.dir = bayesTFR_output_dir, median_only = FALSE)
```


## Summarize Results

### Tables

Three types of tabular summaries can be generated.

1. Tables of counts of countries and geographic regions by presence/absence of tfrSURFs: use the `tabulate_loc_by_surf()` function.
2. Tables of SURF counts and average lengths by geographic regions and other geographies: use the `tabulate_surf_stats()` function.
3. Overall summary: use the `tabulate_surf_periods()` function.

For example, for a concise summary of SURFs by country and time period, issue the following from within *R*:

```{r table-concise}
tabulate_surf_periods(tfr_surf_df_list, table_type = "concise")
```


### Plots

Plots of TFR trends with SURF periods overlaid, or SURF probabilities over time, can be generated by the `plot_tfr_surfs()` function. Combination plots showing both on a single page (for a single country or area) can be obtained using the `plot_surfs_probs()` function. You can pass either of these functions a list or single data frame. Use the `x_alt` argument if you have generated results for non-probabilistic SURFs and you want them to be plotted as well. They will appear as "rugs" at the bottom of the plotting region. See the respective help files for complete documentation of all arguments.

```{r plot-countries}
pdf(file = "Probabilistic_TFR_surfs.pdf", height = 6, width = 14)
plot_surfs_probs(tfr_surfs_lst,
                 x_alt = tfr_surf_df_list_non_prob #< show non-probabilistic SURFs
                 )
dev.off()
```
